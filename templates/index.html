<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open International Hospital</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        h1, h2 { text-align: center; color: #333; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background-color: #fff; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .form-container { margin: 20px 0; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .form-container form { display: flex; flex-wrap: wrap; gap: 10px; }
        .form-container input, .form-container button { padding: 8px; margin: 5px; border: 1px solid #ccc; border-radius: 4px; }
        .form-container button { background-color: #28a745; color: #fff; cursor: pointer; }
        .form-container button:hover { background-color: #218838; }
        .form-container input[type="number"] { width: 100px; }
        .form-container input[type="text"] { width: 150px; }
        .search-form { margin-bottom: 20px; }
        .search-form input { padding: 8px; width: 200px; }
        .search-form button { padding: 8px; }
        .flash-messages { margin-bottom: 20px; }
        .flash-messages .error { color: red; }
        .flash-messages .success { color: green; }
        .pagination { margin-top: 20px; text-align: center; }
        .pagination a { margin: 0 10px; color: #007bff; text-decoration: none; }
        .pagination a:hover { text-decoration: underline; }
    </style>
    <script>
        async function fetchRecord() {
            const id = document.getElementById('update_id').value;
            if (!id) {
                alert('Please enter an ID');
                return;
            }
            try {
                const response = await fetch(`/get_record/${id}`);
                const data = await response.json();
                if (response.ok) {
                    document.getElementById('sn').value = data.sn || '';
                    document.getElementById('date').value = data.date || '';
                    document.getElementById('time').value = data.time || '';
                    document.getElementById('am_number').value = data.am_number || '';
                    document.getElementById('rank').value = data.rank || '';
                    document.getElementById('first_second_name').value = data.first_second_name || '';
                    document.getElementById('unit').value = data.unit || '';
                    document.getElementById('phone_no').value = data.phone_no || '';
                    document.getElementById('age').value = data.age || '';
                    document.getElementById('temp').value = data.temp || '';
                    document.getElementById('bp').value = data.bp || '';
                    document.getElementById('bp1').value = data.bp1 || '';
                    document.getElementById('pauls').value = data.pauls || '';
                    document.getElementById('rest').value = data.rest || '';
                    document.getElementById('wt').value = data.wt || '';
                    document.getElementById('complain').value = data.complain || '';
                    document.getElementById('diagn').value = data.diagn || '';
                    document.getElementById('plan').value = data.plan || '';
                    document.getElementById('rmks').value = data.rmks || '';
                } else {
                    alert(data.error || 'Record not found');
                    clearForm();
                }
            } catch (error) {
                alert('Error fetching record');
                clearForm();
            }
        }

        function clearForm() {
            const idField = document.getElementById('update_id').value;
            document.getElementById('update_form').reset();
            document.getElementById('update_id').value = idField;
        }

        async function submitUpdate() {
            const form = document.getElementById('update_form');
            const formData = new FormData(form);
            formData.append('action', 'update');
            try {
                const response = await fetch('/', {
                    method: 'POST',
                    body: formData
                });
                const text = await response.text();
                if (text.includes('Entry updated successfully')) {
                    alert('Entry updated successfully!');
                    clearForm();
                    location.reload();
                } else {
                    alert('Error updating record');
                }
            } catch (error) {
                alert('Error submitting update');
            }
        }
    </script>
</head>
<body>
    <h1>Open International Hospital</h1>
    <div class="flash-messages">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <p class="{{ category }}">{{ message }}</p>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>
    <p>Welcome, {{ session.username }}! <a href="{{ url_for('logout') }}">Logout</a> {% if session.is_admin %}| <a href="{{ url_for('admin') }}">Admin Panel</a>{% endif %}</p>
    <div class="search-form">
        <form method="POST" action="{{ url_for('index') }}">
            <input type="text" name="search_query" placeholder="Search by SN, Name, AM Number, or Complain" value="{{ search_query }}">
            <button type="submit">Search</button>
        </form>
    </div>
    {% if df is not none and not df.empty %}
        <table>
            <tr>
                {% for col in df.columns %}
                    <th>{{ col.replace('_', ' ').title() }}</th>
                {% endfor %}
            </tr>
            {% for _, row in df.iterrows() %}
                <tr>
                    {% for col in df.columns %}
                        <td>{{ row[col] }}</td>
                    {% endfor %}
                </tr>
            {% endfor %}
        </table>
        <div class="pagination">
            {% if has_prev %}
                <a href="{{ url_for('index', cursor=prev_cursor, direction='prev', search_query=search_query) }}">Previous</a>
            {% endif %}
            {% if has_next %}
                <a href="{{ url_for('index', cursor=next_cursor, direction='next', search_query=search_query) }}">Next</a>
            {% endif %}
        </div>
    {% else %}
        <p>No records found.</p>
    {% endif %}
    {% if can_edit %}
        <div class="form-container">
            <h2>Add Entry</h2>
            <form method="POST" action="{{ url_for('index') }}">
                <input type="hidden" name="action" value="add">
                <input type="text" name="sn" placeholder="SN">
                <input type="text" name="date" placeholder="Date">
                <input type="text" name="time" placeholder="Time">
                <input type="text" name="am_number" placeholder="AM Number">
                <input type="text" name="rank" placeholder="Rank">
                <input type="text" name="first_second_name" placeholder="First & Second Name">
                <input type="text" name="unit" placeholder="Unit">
                <input type="text" name="phone_no" placeholder="Phone No">
                <input type="number" name="age" placeholder="Age">
                <input type="number" name="temp" placeholder="Temp" step="0.1">
                <input type="number" name="bp" placeholder="BP" step="0.1">
                <input type="number" name="bp1" placeholder="BP1" step="0.1">
                <input type="number" name="pauls" placeholder="Pauls">
                <input type="text" name="rest" placeholder="Rest">
                <input type="text" name="wt" placeholder="Wt">
                <input type="text" name="complain" placeholder="Complain">
                <input type="text" name="diagn" placeholder="Diagnosis">
                <input type="text" name="plan" placeholder="Plan">
                <input type="text" name="rmks" placeholder="Remarks">
                <button type="submit">Add</button>
            </form>
        </div>
        <div class="form-container">
            <h2>Update Entry</h2>
            <form id="update_form" method="POST" action="{{ url_for('index') }}">
                <input type="hidden" name="action" value="update">
                <input type="number" id="update_id" name="id" placeholder="ID" required>
                <button type="button" onclick="fetchRecord()">üîç</button>
                <input type="text" id="sn" name="sn" placeholder="SN">
                <input type="text" id="date" name="date" placeholder="Date">
                <input type="text" id="time" name="time" placeholder="Time">
                <input type="text" id="am_number" name="am_number" placeholder="AM Number">
                <input type="text" id="rank" name="rank" placeholder="Rank">
                <input type="text" id="first_second_name" name="first_second_name" placeholder="First & Second Name">
                <input type="text" id="unit" name="unit" placeholder="Unit">
                <input type="text" id="phone_no" name="phone_no" placeholder="Phone No">
                <input type="number" id="age" name="age" placeholder="Age">
                <input type="number" id="temp" name="temp" placeholder="Temp" step="0.1">
                <input type="number" id="bp" name="bp" placeholder="BP" step="0.1">
                <input type="number" id="bp1" name="bp1" placeholder="BP1" step="0.1">
                <input type="number" id="pauls" name="pauls" placeholder="Pauls">
                <input type="text" id="rest" name="rest" placeholder="Rest">
                <input type="text" id="wt" name="wt" placeholder="Wt">
                <input type="text" id="complain" name="complain" placeholder="Complain">
                <input type="text" id="diagn" name="diagn" placeholder="Diagnosis">
                <input type="text" id="plan" name="plan" placeholder="Plan">
                <input type="text" id="rmks" name="rmks" placeholder="Remarks">
                <button type="button" onclick="submitUpdate()">‚úî</button>
            </form>
        </div>
        <div class="form-container">
            <h2>Delete Entry</h2>
            <form method="POST" action="{{ url_for('index') }}">
                <input type="hidden" name="action" value="delete">
                <input type="number" name="id" placeholder="ID" required>
                <button type="submit">Delete</button>
            </form>
        </div>
    {% endif %}
</body>
</html>
